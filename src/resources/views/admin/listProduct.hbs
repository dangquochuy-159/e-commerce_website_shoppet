{{> test}}
<style>
    .avt-admin img {
        width: 50px;
        height: 50px;
    }
</style>
<h1>LIST PRODUCT</h1>
<form class="mt-4" method="POST" name="container-form" action="/admin/danh-sach/san-pham/delete-checked">
    <select class="form-control form-control-sm checkbox-select-all-options" name="action" required>
        <option value="">-- Hành động --</option>
        <option value="delete">Xóa</option>
    </select>
    <button class="btn btn-primary btn-sm btn-submit-check-all" disabled>Áp dụng</button>
    <table class="table mt-4">
        <thead>
            <tr>


                <th class="text-center" scope="col">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="checkbox-all">
                    </div>
                </th>
                <th class="text-center" scope="col">ID</th>
                <th class="text-center" scope="col">Tên sản phẩm</th>
                <th class="text-center" scope="col">Danh mục</th>
                <th class="text-center" scope="col">Số lượng</th>
                <th class="text-center" scope="col">Giá</th>
                <th class="text-center" scope="col">Giá khuyến mãi</th>
                <th class="text-center" scope="col">Ảnh</th>
            </tr>
        </thead>
        <tbody>
            {{#each product}}
            <tr>
                <td>
                    <div class="form-check">
                        <input class="form-check-input " type="checkbox" name="productIds[]" value="{{this.product_ID}}"
                            id="">
                    </div>
                </td>
                <th class="text-center" scope="row">{{this.product_ID}}</th>
                <td class="text-center">{{this.name}}</td>
                <td class="text-center">
                    {{#each ../category}}

                    {{#if (compare ../this.categoryID this.category_ID)}}
                    {{this.name}}
                    {{else}}

                    {{/if}}
                    {{!-- {{{id_to_name ../this.categoryID this}}} --}}
                    {{/each}}
                </td>



                <td class="text-center">{{this.quantity}}</td>
                <td class="text-center">{{ this.price}}</td>
                <td class="text-center">{{this.salePrice}}</td>
                <td class="text-center">
                    <div class="avt-admin">
                        <img src="{{this.image}}" alt="">
                    </div>
                </td>
                <td>
                    <a href="/admin/{{this.product_ID}}/sua/san-pham" type="button" class="btn btn-link">Sửa</a>
                    <button data-id="{{this.product_ID}}" type="button" class="btn btn-link btn-delete"
                        data-bs-toggle="modal" data-bs-target="#delete-product-modal">Xóa</button>
                </td>
            </tr>
            {{!-- trường hợp nếu product không có dữ liệu để hiển thị --}}
            {{else}}
            <tr>
                <td colspan="8" class="text-center">
                    Không có sản phẩm nào
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</form>
<a href="/admin/them/san-pham">ADD PRODUCT</a>

{{! Confirm delete product }}
<div class="modal fade" id="delete-product-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Xóa sản phẩm?</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Hành động này không thể khôi phục!!<br>
                Bạn vẫn muốn xóa sản phẩm?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" id="btn-delete-product" class="btn btn-primary">Xóa</button>
            </div>
        </div>
    </div>
</div>



{{!-- có tác dụng submit DELETE--}}
<form name="delete-form" method="POST"></form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    //khi nào trình duyệt load DOM xong mới thực hiện hàm bên trong
    document.addEventListener('DOMContentLoaded', function () {
        let productId
        const deleteForm = document.forms['delete-form']
        const containerForm = document.querySelector('form[name="container-form"]')
        const btnDeleteProduct = document.getElementById('btn-delete-product')
        const checkboxAll = document.querySelector('#checkbox-all')
        const productItemCheckbox = document.querySelectorAll('input[name="productIds[]"]')
        const checkALlSubmitBtn = document.querySelector('.btn-submit-check-all')
        const btnDeleteList = document.querySelectorAll('.btn-delete')

        //Lấy ra id của sản phẩm mỗi khi click vào button xóa trên sản phẩm
        Array.from(btnDeleteList).forEach(function (btnDelete) {
            btnDelete.onclick = function () {
                productId = this.getAttribute('data-id');
            }
        })

        //khi ấn nút xóa trên form confirm thì thực hiện xóa
        btnDeleteProduct.onclick = function () {
            deleteForm.action = '/admin/xoa/san-pham/' + productId + '?_method=DELETE'
            deleteForm.submit()
        }


        //checkboxAll change
        checkboxAll.onchange = function () {
            let isCheckedAll = this.checked
            Array.from(productItemCheckbox).forEach(function (itemCheck) {
                itemCheck.checked = isCheckedAll
            })
            renderCheckAllSunmitBtn()
        }
        //ProductItemCheckbox change
        Array.from(productItemCheckbox).forEach(function (itemCheck) {
            let isCheck = this.checked
            itemCheck.onchange = function (e) {
                e.checked = !isCheck
                if (countChecked() === productItemCheckbox.length) {
                    checkboxAll.checked = true
                } else {
                    checkboxAll.checked = false
                }
                renderCheckAllSunmitBtn()
            }

        })

        //render lại cái btn submit checkall
        function renderCheckAllSunmitBtn() {
            let checkedCount = countChecked()
            console.log("checkedCount: ", checkedCount)

            if (checkedCount > 0) {
                checkALlSubmitBtn.disabled = false
            } else {
                checkALlSubmitBtn.disabled = true
            }
        }
        function countChecked() {
            let checkedCount = 0
            Array.from(productItemCheckbox).forEach((itemcheck) => {
                if (itemcheck.checked === true) {
                    return checkedCount += 1
                }
            })
            return checkedCount
        }


    })
</script>